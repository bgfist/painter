<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>画图板</title>
    <link rel="stylesheet" href="style.css">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            background-color: #EEE;
            user-select: none;
        }

        #canvas {
            padding: 20px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        }

        canvas {
            background-color: #FFF;
        }

        .form-horizontal {
            margin: 20px;
            width: 1200px;
        }

        .btn {
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <div class="form-horizontal">
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                画布宽度
            </label>
            <div class="col-sm-7">
                <input name="canvasWidth" type="number" value="1000" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                画布高度
            </label>
            <div class="col-sm-7">
                <input name="canvasHeight" type="number" value="1000" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                填充颜色
            </label>
            <div class="col-sm-7">
                <input name="fillStyle" type="color" value="#fccbc9" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                描边粗细
            </label>
            <div class="col-sm-7">
                <input name="lineWidth" type="range" value="2" min="1" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                描边颜色
            </label>
            <div class="col-sm-7">
                <input name="strokeStyle" type="color" value="#777777" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                描边方式
            </label>
            <div class="col-sm-7">
                <label class="radio-inline">
                    <input type="radio" name="strokePosition" value="1"> Inside
                </label>
                <label class="radio-inline">
                    <input type="radio" name="strokePosition" value="2" checked> Center
                </label>
                <label class="radio-inline">
                    <input type="radio" name="strokePosition" value="3"> Outside
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                阴影 x 偏移量
            </label>
            <div class="col-sm-7">
                <input name="shadowOffsetX" type="number" value="1" min="0" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                阴影 y 偏移量
            </label>
            <div class="col-sm-7">
                <input name="shadowOffsetY" type="number" value="1" min="0" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                阴影模糊量
            </label>
            <div class="col-sm-7">
                <input name="shadowBlur" type="number" value="2" min="0" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                阴影颜色
            </label>
            <div class="col-sm-7">
                <input name="shadowColor" type="color" value="#8f8f8f" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                开关
            </label>
            <div class="col-sm-7">
                <label class="checkbox-inline">
                    <input type="checkbox" name="hasFill" checked> 有填充
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="hasStroke" checked> 有描边
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="isDash"> 虚线描边
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="hasShadow"> 有阴影
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                字体大小
            </label>
            <div class="col-sm-7">
                <input name="fontSize" type="number" value="30" min="12" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                当前工具
            </label>
            <div class="col-sm-7">
                <label class="radio-inline">
                    <input type="radio" name="tool" value="0"> 无
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="1"> 直线
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="2"> 矩形
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="3"> 圆
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="4" checked> 涂鸦
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="5"> 多边形
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="6"> 箭头
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="7"> 双向箭头
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="8"> 文字
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="9"> 内多边形
                </label>
                <label class="radio-inline">
                    <input type="radio" name="tool" value="10"> 桃心
                </label>
                <label class="radio-inline">
                    <span class="label label-danger">
                        选中图形后按 Delete 键删除
                    </span>
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                多边形数量
            </label>
            <div class="col-sm-7">
                <input name="count" type="number" value="5" min="3" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                内半径
            </label>
            <div class="col-sm-7">
                <input name="radius" type="number" value="90" min="10" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-7">
                <button class="btn btn-info btn-apply">
                    应用
                </button>
                <button class="btn btn-danger btn-clear">
                    清空
                </button>
                <button class="btn btn-danger btn-remove">
                    删除
                </button>
                <button class="btn btn-warning btn-prev">
                    撤销
                </button>
                <button class="btn btn-warning btn-next">
                    恢复
                </button>
                <button class="btn btn-warning btn-zoom">
                    放大
                </button>
            </div>
        </div>
    </div>
    <div id="canvas" style="position: relative;">
        <canvas id="shapeCanvas"></canvas>
        <canvas id="stateCanvas" style="position: absolute; left: 20px; top: 20px; background: transparent;"></canvas>
    </div>

    <script src="jquery.js"></script>
    <script src="../dist/painter.js"></script>
    <script src="../node_modules/xstream/dist/xstream.js"></script>
    <script>
        'use strict';

        var canvas = $('#shapeCanvas')[0];
        var stateCanvas = $('#stateCanvas')[0];
        var cacheCanvas = document.createElement("canvas");

        function getConfig() {
            var canvasWidth = + $('input[name="canvasWidth"]').val().trim();
            var canvasHeight = + $('input[name="canvasHeight"]').val().trim();
            var fillStyle = $('input[name="fillStyle"]').val();
            var strokeStyle = $('input[name="strokeStyle"]').val();
            var strokePosition = + $('input[name="strokePosition"]:checked').val();
            var lineWidth = + $('input[name="lineWidth"]').val();
            var shadowOffsetX = + $('input[name="shadowOffsetX"]').val().trim();
            var shadowOffsetY = + $('input[name="shadowOffsetY"]').val().trim();
            var shadowBlur = + $('input[name="shadowBlur"]').val().trim();
            var shadowColor = $('input[name="shadowColor"]').val();
            var fontSize = + $('input[name="fontSize"]').val();

            var tool = + $('input[name="tool"]:checked').val();
            var count = + $('input[name="count"]').val().trim();
            var radius = + $('input[name="radius"]').val().trim();
            var hasFill = $('input[name="hasFill"]').prop('checked');
            var hasStroke = $('input[name="hasStroke"]').prop('checked');
            var hasShadow = $('input[name="hasShadow"]').prop('checked');
            var lineDash = $('input[name="isDash"]').prop('checked') ? [10, 10] : [];

            return {
                canvasWidth: canvasWidth,
                canvasHeight: canvasHeight,
                fillStyle: fillStyle,
                strokeStyle: strokeStyle,
                strokePosition: strokePosition,
                lineWidth: lineWidth,
                shadowOffsetX: shadowOffsetX,
                shadowOffsetY: shadowOffsetY,
                shadowBlur: shadowBlur,
                shadowColor: shadowColor,
                fontSize: fontSize,
                caretColor: 'rgba(0,0,0,1)',
                hoverColor: '#ff252c',
                hoverThickness: 3,

                tool: tool,
                count: count,
                radius: radius,
                thickness: 10,
                hasFill: hasFill,
                hasStroke: hasStroke,
                hasShadow: hasShadow,
                lineDash: lineDash
            };
        }

        var draw$ = xstream.Stream.create();
        var config$ = xstream.Stream.create();
        var resize$ = xstream.Stream.create();
        var prev$ = xstream.Stream.create();
        var next$ = xstream.Stream.create();
        var clear$ = xstream.Stream.create();
        var deleteActive$ = xstream.Stream.create();

        function fromEvent(ele, eventName) {
            let listener = null;

            return xstream.Stream.create({
                start(observer) {
                    const { x, y } = ele.getBoundingClientRect();

                    function callback(e) {
                        observer.next({
                            x: e.clientX - x,
                            y: e.clientY - y
                        })
                    }

                    ele.addEventListener(eventName, callback);
                    listener = callback;
                },
                stop() {
                    ele.removeEventListener(eventName, listener);
                }
            });
        };

        const mouseDown$ = fromEvent(stateCanvas, "mousedown");
        const mouseMove$ = fromEvent(stateCanvas, "mousemove");
        const mouseUp$ = fromEvent(stateCanvas, "mouseup");

        const { histories$, drawCanvas$ } = Painter.Canvas({
            canvas, cacheCanvas, stateCanvas,
            mouseStream: {
                mouseDown$,
                mouseMove$,
                mouseUp$
            },
            draw$,
            config$,
            resize$,
            prev$,
            next$,
            clear$,
            deleteActive$
        });

        histories$.subscribe({});
        drawCanvas$.subscribe({});


        // var shapeMap = {
        //     1: Painter.shapes.Line,
        //     2: Painter.shapes.Rect,
        //     3: Painter.shapes.Oval,
        //     4: Painter.shapes.Doodle,
        //     5: Painter.shapes.Polygon,
        //     6: function (props) {
        //         props.double = false;
        //         return new Painter.shapes.Arrow(props)
        //     },
        //     7: function (props) {
        //         props.double = true;
        //         return new Painter.shapes.Arrow(props)
        //     },
        //     8: Painter.shapes.Text,
        //     9: Painter.shapes.Star,
        //     10: Painter.shapes.Heart
        // };

        // var updateCanvas = function (config) {
        //     instance.resize(config.canvasWidth, config.canvasHeight, true);
        //     if (
        //         !instance.apply({
        //             radius: config.radius,
        //             thickness: config.thickness,
        //             count: Math.max(config.count, 3),
        //             fillStyle: config.hasFill ? config.fillStyle : null,
        //             strokeStyle: config.hasStroke ? config.strokeStyle : null,
        //             strokePosition: config.strokePosition,
        //             lineWidth: config.lineWidth,
        //             shadowOffsetX: config.shadowOffsetX,
        //             shadowOffsetY: config.shadowOffsetY,
        //             shadowBlur: config.shadowBlur,
        //             shadowColor: config.hasShadow ? config.shadowColor : null,
        //             fontSize: config.fontSize,
        //             fontFamily: 'sans-serif',
        //             caretColor: config.caretColor,
        //             hoverColor: config.hoverColor,
        //             hoverThickness: config.hoverThickness,
        //             lineDash: config.lineDash
        //         })
        //     ) {
        //         instance.refresh();
        //     }
        //     instance.drawing(
        //         shapeMap[config.tool]
        //     );
        // };
        // updateCanvas(config);

        $('.btn-apply').on('click', function () {
            updateCanvas(getConfig());
        });

        $('.btn-clear').on('click', function () {
            clear$.next();
        });

        $('.btn-remove').on('click', function () {
            deleteActive$.next();
        });

        $('.btn-prev').on('click', function () {
            prev$.next();
        });

        $('.btn-next').on('click', function () {
            next$.next();
        });
        $('.btn-zoom').on('click', function () {
            resize$.next({
                width: canvas.offsetWidth * 2,
                height: canvas.offsetHeight * 2
            });
        });

    </script>
</body>

</html>